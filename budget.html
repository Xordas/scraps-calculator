<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraps Odds Calculator</title>
    <style>
        :root {
        color-scheme: light dark; 
        --bg-color: #ffffff;
        --text-color: #1a1a1a;
        --bg-color-button: #7c7c7c; 
        --text-color-button: #1a1a1a; 
        }

        @media (prefers-color-scheme: dark) {
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f5f5f5; 
            --bg-color-button: rgb(59, 59, 59);
            --text-color-button: #f5f5f5;
            /* waow dark mode!!! */
        }
        }

        body {
        background-color: var(--bg-color);
        color: var(--text-color);
        }

        .Button {
        background-color: var(--bg-color-button);
        color: var(--text-color-button);
        }
    </style>

    <script>
        if (localStorage.getItem("ga_disabled") !== "1") {
            const script = document.createElement("script");
            script.async = true;
            script.src = `https://www.googletagmanager.com/gtag/js?id=G-TXDF9RQ82V`;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];
            window.gtag = window.gtag || function(){dataLayer.push(arguments);};

            gtag('js', new Date());
            gtag('config', 'G-TXDF9RQ82V');
        }

        function gaOptout() {
            if (localStorage.getItem("ga_disabled") !== "1") {
                localStorage.setItem("ga_disabled", "1");
                alert("Google Analytics has been disabled. Please refresh the page for the changes to take effect.");
            } else if (localStorage.getItem("ga_disabled") === "1") {
                localStorage.setItem("ga_disabled", "0");
                alert("Google Analytics has been enabled. Please refresh the page for the changes to take effect.");

            }
        }
    </script>

</head>
<body>
    <h1> This website is no longer accurate as formulas have changed, this will be updated asap!<h1></h1>
    <h1>Scraps Odds Calculator</h1>
    <p>Do not write percentages, write just the number instead (im too lazy to add input validation)</p><br>

    <p>Price per roll:</p>
    <input type="text" id="PricePerRollInput" placeholder="Price per roll"> <br>
    <p>Default roll chance:</p>
    <input type="text" id="DefaultRollChanceInput" placeholder="Default roll chance"> <br>
    <p>Price per upgrade:</p>
    <input type="text" id="PricePerUpgradeInput" placeholder="Price per upgrade"> <br>
    <p>Upgrade chance increase:</p>
    <input type="text" id="UpgradeChanceIncreaseInput" placeholder="Upgrade chance increase"> <br>
    <p>Budget:</p>
    <input type="text" id="BudgetInput" placeholder="Budget"> <br><br>

    <button class="Button" id="CalculateButton">Calculate</button>

    <p id="Result"></p>
    <p id="Result2"></p>
    <p id="Result3"></p>
    <p id="Result4"></p>

    <br><br><br><br><br><br>
    <a href="javascript:gaOptout()">Click here to opt-out of Google Analytics (click again to enable)</a>
    <script>

    </script>


    <!-- I know its not optimized but it work doesnt it? -->
    <!-- Max performance isnt needed for a script like this -->
    <script>

        document.getElementById("CalculateButton").addEventListener("click", function() {
            const PricePerRoll = parseFloat(document.getElementById("PricePerRollInput").value);
            const DefaultRollChance = parseFloat(document.getElementById("DefaultRollChanceInput").value);
            const PricePerUpgrade = parseFloat(document.getElementById("PricePerUpgradeInput").value);
            const UpgradeChanceIncrease = parseFloat(document.getElementById("UpgradeChanceIncreaseInput").value);
            const Budget = parseFloat(document.getElementById("BudgetInput").value);

            let BestProbability = -1;
            let BestUpgrades = 0;
            let BestRolls = 0;
            let BestChancePerRoll = 0;
            let BestCost = 0;

            const EPS = 1e-6;

            // Track compute time for funsies
            const startTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
            let attempts = 0;

            // Maximum upgrades possible
            const MaxUpgrades = Math.ceil((100 - DefaultRollChance) / UpgradeChanceIncrease);

            for (let Upgrades = 0; Upgrades <= MaxUpgrades; Upgrades++) {
                let ChancePerRoll = DefaultRollChance + Upgrades * UpgradeChanceIncrease;
                if (ChancePerRoll > 100) ChancePerRoll = 100;
                const P = ChancePerRoll / 100;

                const costForUpgrades = Upgrades * PricePerUpgrade;

                // Maximum rolls possible with remaining budget
                const MaxRolls = Math.floor((Budget - costForUpgrades) / PricePerRoll);

                // Brute force every possible roll count, now THIS is real optimization
                for (let RollsBought = 1; RollsBought <= MaxRolls; RollsBought++) {
                    attempts += 1;
                    let successProbability = 1 - Math.pow(1 - P, RollsBought);

                    // Anything above 99.5% is basically 100%, solves FP issues from before
                    if (successProbability >= 0.995) successProbability = 1;

                    const totalCostUsed = costForUpgrades + RollsBought * PricePerRoll;

                    // Skip if over budget (shouldn't happen but safe)
                    if (totalCostUsed > Budget) continue;

                    // Update best
                    if (
                        successProbability > BestProbability || 
                        (Math.abs(successProbability - BestProbability) < EPS && totalCostUsed < BestCost)
                    ) {
                        BestProbability = successProbability;
                        BestUpgrades = Upgrades;
                        BestRolls = RollsBought;
                        BestChancePerRoll = ChancePerRoll;
                        BestCost = totalCostUsed;

                        //console.log(`New best: Upgrades ${Upgrades}, Rolls ${RollsBought}, Chance ${(successProbability*100).toFixed(2)}%, Cost ${totalCostUsed.toFixed(2)}`);
                    }
                }
            }

            const endTime = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
            const elapsedMs = endTime - startTime;

            //console.log("=== Optimal Combination ===");
            /*console.log({
                Upgrades: BestUpgrades,
                Rolls: BestRolls,
               ChancePerRoll: BestChancePerRoll,
               successProbability: BestProbability,
                totalCostUsed: BestCost,
                attempts: attempts,
                elapsedMs: elapsedMs
            });*/


            if (BestProbability < 0) {
                document.getElementById("Result").textContent = "Budget too small to buy any rolls with available upgrade choices.";
                document.getElementById("Result2").textContent = "";
                document.getElementById("Result3").textContent = "";
                document.getElementById("Result4").textContent = "";
                return;
            }

            document.getElementById("Result").textContent = `Optimal strategy --> Upgrades: ${BestUpgrades}, Rolls: ${BestRolls}`;

            document.getElementById("Result2").textContent =
                `Success chance: ${(BestProbability * 100).toFixed(2)}% | Cost used: ${BestCost.toFixed(2)} | Chance per roll: ${BestChancePerRoll.toFixed(2)}% | Leftover: ${(Budget - BestCost).toFixed(2)}`;

            document.getElementById("Result3").textContent =
                `Hours: ${(BestCost / 14).toFixed(2)} (T1), ${(BestCost / 16).toFixed(2)} (T2), ${(BestCost / 20).toFixed(2)} (T3), ${(BestCost / 24).toFixed(2)} (T4)`;

            document.getElementById("Result4").textContent = `Compute time: ${elapsedMs.toFixed(2)} ms | Attempts: ${attempts}`;
        });


    </script>
</body>

</html>
